{"version":3,"file":"rate-limiter.js","sourceRoot":"","sources":["../../src/rate-limiter.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,MAAM,EAAE,MAAM,gBAAgB,CAAA;AAEvC,IAAM,uBAAuB,GAAG,EAAE,GAAG,IAAI,CAAA;AAMzC;IAAA;QAAA,iBA8BC;QA7BG,WAAM,GAA2B,EAAE,CAAA;QAW5B,qBAAgB,GAAG,UAAC,cAA8B;YACrD,IAAI;gBACA,IAAM,IAAI,GAAG,cAAc,CAAC,YAAY,CAAA;gBACxC,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;oBACvB,OAAM;iBACT;gBAED,IAAM,QAAQ,GAAoB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;gBAClD,IAAM,oBAAoB,GAAG,QAAQ,CAAC,aAAa,IAAI,EAAE,CAAA;gBACzD,oBAAoB,CAAC,OAAO,CAAC,UAAC,QAAQ;oBAClC,MAAM,CAAC,IAAI,CAAC,wBAAiB,QAAQ,IAAI,QAAQ,uBAAoB,CAAC,CAAA;oBACtE,KAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,GAAG,uBAAuB,CAAA;gBAC1E,CAAC,CAAC,CAAA;aACL;YAAC,OAAO,CAAC,EAAE;gBACR,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC,CAAA;gBACf,OAAM;aACT;QACL,CAAC,CAAA;IACL,CAAC;IA3BU,mCAAa,GAApB,UAAqB,QAA4B;QAC7C,IAAM,UAAU,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,IAAI,QAAQ,CAAC,IAAI,KAAK,CAAA;QAE7D,IAAI,UAAU,KAAK,KAAK,EAAE;YACtB,OAAO,KAAK,CAAA;SACf;QACD,OAAO,IAAI,IAAI,EAAE,CAAC,OAAO,EAAE,GAAG,UAAU,CAAA;IAC5C,CAAC;IAoBL,kBAAC;AAAD,CAAC,AA9BD,IA8BC","sourcesContent":["import { logger } from './utils/logger'\n\nconst oneMinuteInMilliseconds = 60 * 1000\n\ninterface CaptureResponse {\n    quota_limited?: string[]\n}\n\nexport class RateLimiter {\n    limits: Record<string, number> = {}\n\n    public isRateLimited(batchKey: string | undefined): boolean {\n        const retryAfter = this.limits[batchKey || 'events'] || false\n\n        if (retryAfter === false) {\n            return false\n        }\n        return new Date().getTime() < retryAfter\n    }\n\n    public checkForLimiting = (xmlHttpRequest: XMLHttpRequest): void => {\n        try {\n            const text = xmlHttpRequest.responseText\n            if (!text || !text.length) {\n                return\n            }\n\n            const response: CaptureResponse = JSON.parse(text)\n            const quotaLimitedProducts = response.quota_limited || []\n            quotaLimitedProducts.forEach((batchKey) => {\n                logger.info(`[RateLimiter] ${batchKey || 'events'} is quota limited.`)\n                this.limits[batchKey] = new Date().getTime() + oneMinuteInMilliseconds\n            })\n        } catch (e) {\n            logger.error(e)\n            return\n        }\n    }\n}\n"]}